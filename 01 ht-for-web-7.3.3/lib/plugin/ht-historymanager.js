!function(a,K){"use strict";var I=a.ht,Z=I.Default,a=Z.def,A=Z.getInternal();I.HistoryManager=function(a){this._histories=[],this.setDataModel(a)},a(I.HistoryManager,K,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){var a;this._disabled||((a=this)._betweenTransaction++,1===a._betweenTransaction&&(a._transactionHistories={}))},endTransaction:function(){if(0!==this._betweenTransaction){var a=this,K=a._histories;if(0<a._betweenTransaction&&a._betweenTransaction--,0===a._betweenTransaction){if(a._transactionHistories){var o,h=[];for(o in a._transactionHistories)h.push(a._transactionHistories[o]);h.length&&((K=K.slice(0,a._historyIndex+1)).push(h),K.length>a._maxHistoryCount&&(K=K.slice(K.length-a._maxHistoryCount)),a.setHistories(K),a.setHistoryIndex(K.length-1,!0))}delete a._transactionHistories}}},setDataModel:function(a){var K=this,o=K._dataModel;o!==a&&(o&&(delete o._historyManager,o.ump(K.handleDataModelPropertyChange,K),o.umm(K.$5p,K),o.umd(K.$6p,K),o.removeHierarchyChangeListener(K.handleHierarchyChange,K),o.removeIndexChangeListener(K.handleIndexChange,K)),(K._dataModel=a)&&(a._historyManager=K,a.mp(K.handleDataModelPropertyChange,K),a.mm(K.$5p,K),a.md(K.$6p,K),a.addHierarchyChangeListener(K.handleHierarchyChange,K),a.addIndexChangeListener(K.handleIndexChange,K)),K.fp("dataModel",o,a),K.clear())},setHistoryIndex:function(a,K){var o=this,h=o._historyIndex,V=o._histories.length;a<-1?a=-1:V<=a&&(a=V-1),h!==a&&(K||(0<(V=a-h)?o.$2p(V):V<0&&o.$1p(-V)),o._historyIndex=a,o.fp("historyIndex",h,a),o.dataModel&&o.dataModel.onHistoryManagerChanged())},setMaxHistoryCount:function(a){var K=this,o=K._histories,h=K._maxHistoryCount;h!==(a=!a||a<=0?10:a)&&(K._maxHistoryCount=a,K.fp("maxHistoryCount",h,a),o.length>a&&K.clear())},cloneValue:function(a,K,o){return I.Default.clone(a)},isPropertyUndoable:function(a,K){return a&&!this.ignoredPropertyMap[a]},isIndexUndoable:function(a){return!1},isDataModelPropertyUndoable:function(a,K){return a&&!this.ignoreDataModelPropertyMap[a]},$5p:function(a){this.handleChange(a,a.kind)},$6p:function(a){this.handleChange(a,"property")},handleHierarchyChange:function(a){this.handleChange(a,"hierarchy")},handleIndexChange:function(a){this.handleChange(a,"index")},handleDataModelPropertyChange:function(a){this.handleChange(a,"dataModelProperty")},toChildrenInfo:function(a){var K={};return K.data=a,K.children=[],a.eachChild(function(a){K.children.push(this.toChildrenInfo(a))},this),K},restoreChildren:function(a){var o=a.data;a.children.forEach(function(a){var K=a.data;K.getParent()!==o&&o.addChild(K),this._dataModel.contains(K)||this._dataModel.add(K),this.restoreChildren(a)},this)},handleChange:function(a,K){var o,h,V,W,J=this;J._disabled||J._isUndoRedoing||Z.loadingRefGraph||(J._histories,o=a.data,h=a.property,o&&(o._refGraph||o instanceof I.RefGraph)||("property"===K?J.isPropertyUndoable(h,o)&&(W={kind:K,data:o,property:h,oldValue:J.cloneValue(a.oldValue,o,h),newValue:J.cloneValue(a.newValue,o,h),event:a}):"hierarchy"===K||"index"===K&&J.isIndexUndoable(a)?W={kind:K,data:o,oldIndex:a.oldIndex,newIndex:a.newIndex,event:a}:"clear"===K?W={kind:K,json:a.json,event:a}:"add"===K?((W={kind:K,data:o,event:a,childrenInfo:this.toChildrenInfo(o),parent:o.getParent()}).parent&&(V=J._dataModel.getSiblings(o),W.siblingsIndex=V.indexOf(o)),o instanceof I.Node&&(W.host=o.getHost(),W.attaches=o.getAttaches()?o.getAttaches().toArray():void 0),o instanceof I.Edge&&(W.source=o.getSource(),W.target=o.getTarget())):"remove"===K?W={kind:K,data:o,event:a}:"dataModelProperty"===K&&J.isDataModelPropertyUndoable(h,o)&&(W={kind:K,property:h,oldValue:J.cloneValue(a.oldValue,o,h),newValue:J.cloneValue(a.newValue,o,h),event:a}),J.addHistory(W)))},addHistory:function(a){var K,o,h=this;a&&(h._betweenTransaction?(K=(a.data?a.data._id:0)+"_"+a.kind+"_"+a.property,"property"!==a.kind&&"dataModelProperty"!==a.kind||(o=h._transactionHistories[K])&&(a.oldValue=o.oldValue),h._transactionHistories[K]=a):((o=(o=h._histories).slice(0,h._historyIndex+1)).push([a]),o.length>h._maxHistoryCount&&(o=o.slice(o.length-h._maxHistoryCount)),h.setHistories(o),h.setHistoryIndex(o.length-1,!0)))},canUndo:function(){return!this._disabled&&0<=this._historyIndex&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&-1<=this._historyIndex&&this._historyIndex<this._histories.length-1},undo:function(a){this.setHistoryIndex(this._historyIndex-(a=!a||a<=0?1:a))},$1p:function(a){if(this.canUndo()){var K,o=this,h=o._dataModel,V=o._histories,W=o._historyIndex,J=0;for(o._isUndoRedoing=!0,Z.setIsolating(!0);0<a;){if(0<=W&&W<V.length){J++,K=V[W],W--;for(var G=K.length-1;0<=G;G--){var O,w=K[G],y=w.kind,v=w.data,C=w.property,p=w.event,b=this.cloneValue(w.oldValue,v,C);w.undo?w.undo():"add"===y?h.remove(v,{keepChildren:!0}):"remove"===y?h.contains(v)||h.add(v,p.rootsIndex,p.datasIndex):"clear"===y?h.deserialize(Z.clone(w.json)):"property"===y?"parent"===C?b?b.addChild(v,p.oldIndex):(v.setParent(b),0<=p.oldIndex&&h.moveTo(v,p.oldIndex)):(O=null,0===C.indexOf("a:")?(O="attr",C=C.replace("a:","")):0===C.indexOf("s:")?(O="style",C=C.replace("s:","")):0===C.indexOf("f:")&&(O="field",C=C.replace("f:","")),A.setPropertyValue(v,O,C,b)):"dataModelProperty"===y?(O=null,0===C.indexOf("a:")?(O="attr",C=C.replace("a:","")):0===C.indexOf("s:")?(O="style",C=C.replace("s:","")):0===C.indexOf("f:")&&(O="field",C=C.replace("f:","")),A.setPropertyValue(h,O,C,b)):"hierarchy"===y?h.moveTo(v,w.oldIndex):"index"===y?h.moveToIndex(v,w.oldIndex):"selection"===y&&h.sm().ss(w.oldValue)}}a--}Z.setIsolating(!1),delete o._isUndoRedoing,o.afterUndo(J)}},afterUndo:function(a){},redo:function(a){this.setHistoryIndex(this._historyIndex+(a=!a||a<=0?1:a))},$2p:function(a){if(this.canRedo()){var K=this,o=K._dataModel,h=K._histories,V=K._historyIndex,W=0;for(K._isUndoRedoing=!0,Z.setIsolating(!0);0<a;){if(-1<=V&&V<h.length-1){W++;for(var J=h[++V],G=0;G<J.length;G++){var O,w=J[G],y=w.kind,v=w.data,C=w.property,p=w.event,b=this.cloneValue(w.newValue,v,C);w.redo?w.redo():"add"===y?(w.parent&&!v.getParent()&&w.parent.addChild(v,w.siblingsIndex),o.contains(v)||o.add(v,p.rootsIndex,p.datasIndex),this.restoreChildren(w.childrenInfo),v instanceof I.Node&&(v.setHost(w.host),w.attaches&&w.attaches.forEach(function(a){a.setHost(v)})),v instanceof I.Edge&&(v.setSource(w.source),v.setTarget(w.target))):"remove"===y?o.remove(v):"clear"===y?o.clear():"property"===y?"parent"===C?b?b.addChild(v,p.newIndex):(v.setParent(b),0<=p.newIndex&&o.moveTo(v,p.newIndex)):(O=null,0===C.indexOf("a:")?(O="attr",C=C.replace("a:","")):0===C.indexOf("s:")?(O="style",C=C.replace("s:","")):0===C.indexOf("f:")&&(O="field",C=C.replace("f:","")),A.setPropertyValue(v,O,C,b)):"dataModelProperty"===y?(O=null,0===C.indexOf("a:")?(O="attr",C=C.replace("a:","")):0===C.indexOf("s:")?(O="style",C=C.replace("s:","")):0===C.indexOf("f:")&&(O="field",C=C.replace("f:","")),A.setPropertyValue(o,O,C,b)):"hierarchy"===y?o.moveTo(v,w.newIndex):"index"===y?o.moveToIndex(v,w.newIndex):"selection"===y&&o.sm().ss(w.newValue)}}a--}Z.setIsolating(!1),delete K._isUndoRedoing,this.afterRedo(W)}},afterRedo:function(a){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);