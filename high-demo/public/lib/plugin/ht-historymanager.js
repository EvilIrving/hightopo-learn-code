!function($,y){"use strict";var Y=$.ht,U=Y.Default,$=U.def,q=U.getInternal();Y.HistoryManager=function($){this._histories=[],this.setDataModel($)},$(Y.HistoryManager,y,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,material:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){var $;this._disabled||(($=this)._betweenTransaction++,1===$._betweenTransaction&&($._transactionHistories={}))},endTransaction:function(){if(0!==this._betweenTransaction){var $=this,y=$._histories;if(0<$._betweenTransaction&&$._betweenTransaction--,0===$._betweenTransaction){if($._transactionHistories){var u,e=[];for(u in $._transactionHistories)e.push($._transactionHistories[u]);e.length&&((y=y.slice(0,$._historyIndex+1)).push(e),y.length>$._maxHistoryCount&&(y=y.slice(y.length-$._maxHistoryCount)),$.setHistories(y),$.setHistoryIndex(y.length-1,!0))}delete $._transactionHistories}}},setDataModel:function($){var y=this,u=y._dataModel;u!==$&&(u&&(delete u._historyManager,u.ump(y.handleDataModelPropertyChange,y),u.umm(y.$5p,y),u.umd(y.$6p,y),u.removeHierarchyChangeListener(y.handleHierarchyChange,y),u.removeIndexChangeListener(y.handleIndexChange,y)),(y._dataModel=$)&&($._historyManager=y,$.mp(y.handleDataModelPropertyChange,y),$.mm(y.$5p,y),$.md(y.$6p,y),$.addHierarchyChangeListener(y.handleHierarchyChange,y),$.addIndexChangeListener(y.handleIndexChange,y)),y.fp("dataModel",u,$),y.clear())},setHistoryIndex:function($,y){var u=this,e=u._historyIndex,w=u._histories.length;$<-1?$=-1:w<=$&&($=w-1),e!==$&&(y||(0<(w=$-e)?u.$2p(w):w<0&&u.$1p(-w)),u._historyIndex=$,u.fp("historyIndex",e,$),u.dataModel&&u.dataModel.onHistoryManagerChanged())},setMaxHistoryCount:function($){var y=this,u=y._histories,e=y._maxHistoryCount;e!==($=!$||$<=0?10:$)&&(y._maxHistoryCount=$,y.fp("maxHistoryCount",e,$),u.length>$&&y.clear())},cloneValue:function($,y,u){return Y.Default.clone($)},isPropertyUndoable:function($,y){return $&&!this.ignoredPropertyMap[$]},isIndexUndoable:function($){return!1},isDataModelPropertyUndoable:function($,y){return $&&!this.ignoreDataModelPropertyMap[$]},$5p:function($){this.handleChange($,$.kind)},$6p:function($){this.handleChange($,"property")},handleHierarchyChange:function($){this.handleChange($,"hierarchy")},handleIndexChange:function($){this.handleChange($,"index")},handleDataModelPropertyChange:function($){this.handleChange($,"dataModelProperty")},toChildrenInfo:function($){var y={};return y.data=$,y.children=[],$.eachChild(function($){y.children.push(this.toChildrenInfo($))},this),y},restoreChildren:function($){var u=$.data;$.children.forEach(function($){var y=$.data;y.getParent()!==u&&u.addChild(y),this._dataModel.contains(y)||this._dataModel.add(y),this.restoreChildren($)},this)},handleChange:function($,y){var u,e,w,a,g=this;g._disabled||g._isUndoRedoing||U.loadingRefGraph||(g._histories,u=$.data,e=$.property,u&&(u._refGraph||u instanceof Y.RefGraph)||("property"===y?g.isPropertyUndoable(e,u)&&(a={kind:y,data:u,property:e,oldValue:g.cloneValue($.oldValue,u,e),newValue:g.cloneValue($.newValue,u,e),event:$}):"hierarchy"===y||"index"===y&&g.isIndexUndoable($)?a={kind:y,data:u,oldIndex:$.oldIndex,newIndex:$.newIndex,event:$}:"clear"===y?a={kind:y,json:$.json,event:$}:"add"===y?((a={kind:y,data:u,event:$,childrenInfo:this.toChildrenInfo(u),parent:u.getParent()}).parent&&(w=g._dataModel.getSiblings(u),a.siblingsIndex=w.indexOf(u)),u instanceof Y.Node&&(a.host=u.getHost(),a.attaches=u.getAttaches()?u.getAttaches().toArray():void 0),u instanceof Y.Edge&&(a.source=u.getSource(),a.target=u.getTarget())):"remove"===y?a={kind:y,data:u,event:$}:"dataModelProperty"===y&&g.isDataModelPropertyUndoable(e,u)&&(a={kind:y,property:e,oldValue:g.cloneValue($.oldValue,u,e),newValue:g.cloneValue($.newValue,u,e),event:$}),g.addHistory(a)))},addHistory:function($){var y,u,e=this;$&&(e._betweenTransaction?(y=($.data?$.data._id:0)+"_"+$.kind+"_"+$.property,"property"!==$.kind&&"dataModelProperty"!==$.kind||(u=e._transactionHistories[y])&&($.oldValue=u.oldValue),e._transactionHistories[y]=$):((u=(u=e._histories).slice(0,e._historyIndex+1)).push([$]),u.length>e._maxHistoryCount&&(u=u.slice(u.length-e._maxHistoryCount)),e.setHistories(u),e.setHistoryIndex(u.length-1,!0)))},canUndo:function(){return!this._disabled&&0<=this._historyIndex&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&-1<=this._historyIndex&&this._historyIndex<this._histories.length-1},undo:function($){this.setHistoryIndex(this._historyIndex-($=!$||$<=0?1:$))},$1p:function($){if(this.canUndo()){var y,u=this,e=u._dataModel,w=u._histories,a=u._historyIndex,g=0;for(u._isUndoRedoing=!0,U.setIsolating(!0);0<$;){if(0<=a&&a<w.length){g++,y=w[a],a--;for(var R=y.length-1;0<=R;R--){var S,E=y[R],o=E.kind,t=E.data,r=E.property,d=E.event,b=this.cloneValue(E.oldValue,t,r);E.undo?E.undo():"add"===o?e.remove(t,{keepChildren:!0}):"remove"===o?e.contains(t)||e.add(t,d.rootsIndex,d.datasIndex):"clear"===o?e.deserialize(U.clone(E.json)):"property"===o?"parent"===r?b?b.addChild(t,d.oldIndex):(t.setParent(b),0<=d.oldIndex&&e.moveTo(t,d.oldIndex)):(S=null,0===r.indexOf("a:")?(S="attr",r=r.replace("a:","")):0===r.indexOf("s:")?(S="style",r=r.replace("s:","")):0===r.indexOf("f:")&&(S="field",r=r.replace("f:","")),q.setPropertyValue(t,S,r,b)):"dataModelProperty"===o?(S=null,0===r.indexOf("a:")?(S="attr",r=r.replace("a:","")):0===r.indexOf("s:")?(S="style",r=r.replace("s:","")):0===r.indexOf("f:")&&(S="field",r=r.replace("f:","")),q.setPropertyValue(e,S,r,b)):"hierarchy"===o?e.moveTo(t,E.oldIndex):"index"===o?e.moveToIndex(t,E.oldIndex):"selection"===o&&e.sm().ss(E.oldValue)}}$--}U.setIsolating(!1),delete u._isUndoRedoing,u.afterUndo(g)}},afterUndo:function($){},redo:function($){this.setHistoryIndex(this._historyIndex+($=!$||$<=0?1:$))},$2p:function($){if(this.canRedo()){var y=this,u=y._dataModel,e=y._histories,w=y._historyIndex,a=0;for(y._isUndoRedoing=!0,U.setIsolating(!0);0<$;){if(-1<=w&&w<e.length-1){a++;for(var g=e[++w],R=0;R<g.length;R++){var S,E=g[R],o=E.kind,t=E.data,r=E.property,d=E.event,b=this.cloneValue(E.newValue,t,r);E.redo?E.redo():"add"===o?(E.parent&&!t.getParent()&&E.parent.addChild(t,E.siblingsIndex),u.contains(t)||u.add(t,d.rootsIndex,d.datasIndex),this.restoreChildren(E.childrenInfo),t instanceof Y.Node&&(t.setHost(E.host),E.attaches&&E.attaches.forEach(function($){$.setHost(t)})),t instanceof Y.Edge&&(t.setSource(E.source),t.setTarget(E.target))):"remove"===o?u.remove(t):"clear"===o?u.clear():"property"===o?"parent"===r?b?b.addChild(t,d.newIndex):(t.setParent(b),0<=d.newIndex&&u.moveTo(t,d.newIndex)):(S=null,0===r.indexOf("a:")?(S="attr",r=r.replace("a:","")):0===r.indexOf("s:")?(S="style",r=r.replace("s:","")):0===r.indexOf("f:")&&(S="field",r=r.replace("f:","")),q.setPropertyValue(t,S,r,b)):"dataModelProperty"===o?(S=null,0===r.indexOf("a:")?(S="attr",r=r.replace("a:","")):0===r.indexOf("s:")?(S="style",r=r.replace("s:","")):0===r.indexOf("f:")&&(S="field",r=r.replace("f:","")),q.setPropertyValue(u,S,r,b)):"hierarchy"===o?u.moveTo(t,E.newIndex):"index"===o?u.moveToIndex(t,E.newIndex):"selection"===o&&u.sm().ss(E.newValue)}}$--}U.setIsolating(!1),delete y._isUndoRedoing,this.afterRedo(a)}},afterRedo:function($){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);